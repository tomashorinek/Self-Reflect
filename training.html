<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Self-Coaching Plan Generator</title>
<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
  background-color: #121212;
  color: #e0e0e0;
  margin: 0;
  padding: 2rem;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.container {
  width: 100%;
  max-width: 700px;
}
h1 { color: #ff8c00; }
form, .output {
  background: #1e1e1e;
  padding: 2rem;
  border-radius: 8px;
  border: 1px solid #333;
  width: 100%;
  box-sizing: border-box;
}
label {
  display: block;
  margin-top: 1rem;
  margin-bottom: 0.5rem;
  font-weight: bold;
}
select, input, textarea {
  width: 100%;
  padding: 0.75rem;
  background: #2a2a2a;
  color: #e0e0e0;
  border: 1px solid #444;
  border-radius: 4px;
  box-sizing: border-box;
}
button {
  background: #ff8c00;
  color: #121212;
  font-weight: bold;
  padding: 1rem;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  width: 100%;
  margin-top: 2rem;
  font-size: 1rem;
}
.gym-input-wrapper {
  display: flex;
  gap: 0.5rem;
  margin-top: 0.5rem;
}
.remove-btn {
  background-color: #8b0000;
  padding: 0.5rem;
  border: none;
  border-radius: 4px;
  color: white;
  cursor: pointer;
}
.day {
  margin-bottom: 1.5rem;
  padding: 1rem;
  background: #222;
  border-radius: 6px;
}
.exercise {
  padding: 0.5rem;
  margin-bottom: 0.5rem;
  background: #333;
  border-radius: 4px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: grab;
}
.alt-button {
  cursor: pointer;
  margin-left: 1rem;
}
#trainingPlanContent {
  width: 100%;
  height: 300px;
  background: #1c1c1c;
  color: #fff;
  border: 1px solid #444;
  padding: 1rem;
  border-radius: 6px;
  margin-top: 1rem;
}
#specificGymNameContainer {
  margin-top: 1rem;
  display: block;
}
#specificGymNameContainer label {
  margin-bottom: 0.25rem;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
</head>
<body>
<div class="container">
  <h1>Self-Coaching Plan Generator</h1>
  <form id="trackerForm">
    <label for="goal">What's your main goal?</label>
    <select id="goal">
      <option value="Build muscle">Build muscle</option>
      <option value="Lose fat">Lose fat</option>
      <option value="Get stronger">Get stronger</option>
      <option value="Improve conditioning">Improve conditioning</option>
    </select>

    <label for="frequency">Training days per week:</label>
    <select id="frequency">
      <option value="1-2">1–2</option>
      <option value="3-4">3–4</option>
      <option value="5">5</option>
      <option value="5plus">5+</option>
    </select>

    <label for="equipment">Equipment Access:</label>
    <select id="equipment">
      <option value="gym">Gym</option>
      <option value="home">Home</option>
      <option value="other">Other Gym (specify below)</option>
    </select>

    <div id="specificGymNameContainer" style="display:none;">
      <label for="specificGymName">Specify Other Gym Name:</label>
      <input type="text" id="specificGymName" placeholder="E.g., Local Fitness, My Garage" />
    </div>

    <label for="experience">Training experience:</label>
    <select id="experience">
      <option value="Beginner">Beginner</option>
      <option value="Intermediate">Intermediate</option>
      <option value="Advanced">Advanced</option>
    </select>

    <label for="fixed">Fixed schedule?</label>
    <select id="fixed">
      <option value="Yes">Yes</option>
      <option value="No">No</option>
    </select>

    <label>Your Gyms:</label>
    <div id="gymFields"></div>
    <button type="button" id="addGymButton">➕ Add another gym</button>

    <label for="email">Your email (optional):</label>
    <input type="email" id="email" placeholder="you@example.com" />

    <button type="submit">Generate My Plan</button>
  </form>

  <div class="output" id="outputBox" style="display:none">
    <h2>Your Training Plan</h2>
    <div id="training-container"></div>
    <textarea id="trainingPlanContent" readonly></textarea>
    <button id="continueButton">Export Plan</button>
    <div id="finalStatus"></div>
  </div>
</div>

<script type="module">
import { generateTrainingPlan } from './planLogic.js';

document.addEventListener('DOMContentLoaded', () => {
  const apiUrl = 'https://webbyfe-proxy.quiet-king-42b1.workers.dev/';
  const goal = document.getElementById('goal');
  const frequency = document.getElementById('frequency');
  const equipment = document.getElementById('equipment');
  const experience = document.getElementById('experience');
  const fixed = document.getElementById('fixed');
  const email = document.getElementById('email');

  // Funkce pro přidání gym input pole
  function addGymField(value = '') {
    const wrapper = document.createElement('div');
    wrapper.className = 'gym-input-wrapper';

    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'gymName';
    input.placeholder = 'Your gym...';
    input.value = value;

    const removeBtn = document.createElement('button');
    removeBtn.className = 'remove-btn';
    removeBtn.textContent = '✖';
    removeBtn.onclick = () => wrapper.remove();

    wrapper.appendChild(input);
    wrapper.appendChild(removeBtn);
    document.getElementById('gymFields').appendChild(wrapper);
  }

  // Přidání prvního gym pole při načtení stránky
  addGymField();

  // Přidání listeneru pro tlačítko přidání gymu
  document.getElementById('addGymButton').addEventListener('click', () => {
    addGymField();
  });

  // Logika pro zobrazení/skrytí pole "Specific Gym Name"
  const specificGymNameContainer = document.getElementById('specificGymNameContainer');
  const specificGymNameInput = document.getElementById('specificGymName');

  equipment.addEventListener('change', () => {
    if (equipment.value === 'other') {
      specificGymNameContainer.style.display = 'block';
    } else {
      specificGymNameContainer.style.display = 'none';
      specificGymNameInput.value = '';
    }
  });

  // Zavolání změny při načtení stránky
  equipment.dispatchEvent(new Event('change'));

  // Blokování Enter v inputu
  document.getElementById('trackerForm').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && (e.target.classList.contains('gymName') || e.target.id === 'specificGymName')) {
      e.preventDefault();
    }
  });

  // Funkce pro aktualizaci textarea s plánem
  function updateTrainingPlanContentInTextarea() {
    const container = document.getElementById('training-container');
    const textarea = document.getElementById('trainingPlanContent');
    if (!container || !textarea) return;

    let output = '';
    const days = container.querySelectorAll('.day');
    if (!days || days.length === 0) {
      textarea.value = '';
      return;
    }

    const gymNames = window.formData?.gymNames?.join(', ') || 'None';
    output += `Gyms: ${gymNames}\n\n`;

    days.forEach((day, i) => {
      const title = day.querySelector('h3')?.innerText.trim() || `Day ${i + 1}`;
      output += `${title}\n`;
      day.querySelectorAll('.exercise').forEach(ex => {
        const tempEx = ex.cloneNode(true);
        tempEx.querySelectorAll('.alt-list, .alt-button').forEach(el => el.remove());
        const cleanedText = tempEx.textContent.replace(/\s+/g, ' ').trim();
        output += `- ${cleanedText}\n`;
      });
      output += '\n';
    });

    textarea.value = output.trim();
  }

  // Funkce pro aktivaci drag and drop
  function activateDragAndDrop() {
    const container = document.getElementById('training-container');
    if (container) {
      new Sortable(container, {
        animation: 150,
        handle: '.exercise',
        onEnd: updateTrainingPlanContentInTextarea
      });
    }
  }

  // Odeslání formuláře - generování plánu
  document.getElementById('trackerForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const gymNames = Array.from(document.querySelectorAll('.gymName'))
      .map(x => x.value.trim())
      .filter(x => x);

    // Získání specifického názvu gymu
    const equipmentValue = equipment.value;
    const specificGymName = specificGymNameInput.value.trim();

    if (equipmentValue === 'other') {
      if (!specificGymName) {
        return alert('Please specify the name of your other gym.');
      }
      gymNames.unshift(specificGymName);
    }

    if (!gymNames.length) return alert('Add at least one gym.');

    const data = {
      goal: goal.value,
      frequency: frequency.value,
      equipment: equipmentValue,
      experience: experience.value,
      fixed: fixed.value,
      gymNames,
      email: email.value.trim()
    };

    try {
      document.getElementById('outputBox').style.display = 'none';

      window.formData = data;
      await generateTrainingPlan(data);
      setTimeout(() => {
        activateDragAndDrop();
        updateTrainingPlanContentInTextarea();
        document.getElementById('outputBox').style.display = 'block';
        document.getElementById('trainingPlanContent').setAttribute('readonly', true);
      }, 50);
    } catch (err) {
      alert('❌ Error generating plan: ' + err.message);
    }
  });

  // Tlačítko Export Plan
  document.getElementById('continueButton').addEventListener('click', async () => {
    const finalStatus = document.getElementById('finalStatus');
    finalStatus.textContent = '';
    finalStatus.style.color = '#ffa500';

    updateTrainingPlanContentInTextarea();

    const trainingPlan = document.getElementById('trainingPlanContent').value.trim();
    const gymNames = Array.from(document.querySelectorAll('.gymName'))
      .map(x => x.value.trim())
      .filter(x => x);
    const userName = email.value.trim() || "Anonymous";

    const equipmentValue = equipment.value;
    const specificGymName = specificGymNameInput.value.trim();

    if (equipmentValue === 'other' && specificGymName) {
      gymNames.unshift(specificGymName);
    }

    if (!trainingPlan) {
      finalStatus.textContent = '❌ Training plan is empty. Please generate a plan first, or ensure it contains exercises.';
      finalStatus.style.color = '#ff3333';
      return;
    }

    try {
      finalStatus.textContent = '📤 Uploading plan...';
      const res = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userName, trainingPlan, gymNames })
      });

      const json = await res.json();

      if (json.success) {
        finalStatus.innerHTML = `✅ <a href="${json.url}" target="_blank">Open Logbook</a>`;
        finalStatus.style.color = '#00ff88';
      } else {
        throw new Error(json.error || "Unexpected server error.");
      }
    } catch (err) {
      finalStatus.textContent = `❌ ${err.message}. Please check your Apps Script deployment and logs.`;
      finalStatus.style.color = '#ff3333';
    }
  });

  // Logika pro změnu alternativy
  document.getElementById('training-container').addEventListener('click', async (event) => {
    if (event.target.classList.contains('alt-button')) {
      const altButton = event.target;
      const exerciseElement = altButton.closest('.exercise');
      if (!exerciseElement) return;

      const dayElement = altButton.closest('.day');
      const dayIndex = Array.from(dayElement.parentNode.children).indexOf(dayElement);
      const exerciseIndex = Array.from(dayElement.querySelectorAll('.exercise')).indexOf(exerciseElement);

      console.log(`Clicked alt button for Day ${dayIndex}, Exercise ${exerciseIndex}`);
      alert('Alternative exercise logic needs to be implemented in planLogic.js');
    }
  });
});
</script>
</body>
</html>
