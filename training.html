<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Self-Coaching Plan Generator</title>
<style>
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background:#121212; color:#e0e0e0; margin:0; padding:2rem; display:flex; flex-direction:column; align-items:center;}
  .container{width:100%; max-width:700px;}
  h1{color:#ff8c00;}
  form,.output{background:#1e1e1e; padding:2rem; border-radius:8px; border:1px solid #333; width:100%; box-sizing:border-box;}
  label{display:block; margin-top:1rem; margin-bottom:.5rem; font-weight:bold;}
  select,input,textarea{width:100%; padding:.75rem; background:#2a2a2a; color:#e0e0e0; border:1px solid #444; border-radius:4px; box-sizing:border-box;}
  button{background:#ff8c00; color:#121212; font-weight:bold; padding:1rem; border:none; border-radius:4px; cursor:pointer; width:100%; margin-top:2rem; font-size:1rem;}
  .gym-input-wrapper{display:flex; gap:.5rem; margin-top:.5rem;}
  .remove-btn{background:#8b0000; padding:.5rem; border:none; border-radius:4px; color:#fff; cursor:pointer;}
  .day{margin-bottom:1.5rem; padding:1rem; background:#222; border-radius:6px;}
  .exercise{padding:.5rem; margin-bottom:.5rem; background:#333; border-radius:4px; display:flex; justify-content:space-between; align-items:center; cursor:grab;}
  .alt-button{cursor:pointer; margin-left:1rem;}
  #trainingPlanContent{width:100%; height:300px; background:#1c1c1c; color:#fff; border:1px solid #444; padding:1rem; border-radius:6px; margin-top:1rem;}
  .row{ margin:.5rem 0 0; }
  .inline { display:flex; gap:1rem; align-items:center; }
  .inline label { margin:0; }
  #gymsBlock{ margin-top:1rem; }

  /* Advice (injected after generation) */
  .advice-card{margin:1rem 0;padding:1rem;border:1px solid #6b5f1a;border-radius:8px;background:#1b1a12;color:#f1e7b6}
  .advice-card b{font-weight:700}
</style>

<!-- Sortable.js (for DnD in planLogic.js) -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
</head>
<body>
<div class="container">
  <h1>Self-Coaching Plan Generator</h1>

  <form id="trackerForm">
    <label for="goal">What's your main goal?</label>
    <select id="goal">
      <option value="Build muscle">Build muscle</option>
      <option value="Lose fat">Lose fat</option>
      <option value="Get stronger">Get stronger</option>
      <option value="Improve conditioning">Improve conditioning</option>
    </select>

    <label for="frequency">Training days per week:</label>
    <select id="frequency">
      <option value="1-2">1‚Äì2</option>
      <option value="3-4">3‚Äì4</option>
      <option value="5">5</option>
      <option value="5+">5+</option>
    </select>

    <label>Location</label>
    <div class="inline">
      <label><input type="radio" name="loc" value="gym" checked> Gym</label>
      <label><input type="radio" name="loc" value="home"> Home</label>
    </div>

    <div class="row">
      <label class="inline"><input id="preferMachines" type="checkbox" checked>
        Prefer machines in the first 4‚Äì8 weeks
      </label>
    </div>

    <div id="gymsBlock">
      <label>Your Gyms:</label>
      <div id="gymFields"></div>
      <button type="button" id="addGymButton">‚ûï Add another gym</button>
    </div>

    <label for="email">Your email (optional):</label>
    <input type="email" id="email" placeholder="you@example.com" />

    <button type="submit">Generate My Plan</button>
  </form>

  <div class="output" id="outputBox" style="display:none">
    <div id="starterAdviceMount"></div>  <!-- advice appears here after generation -->
    <h2>Your Training Plan</h2>

    <div id="training-container"></div>
    <textarea id="trainingPlanContent" readonly></textarea>
    <button id="continueButton">Export Plan</button>
    <div id="finalStatus"></div>

    <!-- Brief explainer -->
    <details style="margin-top:1rem">
      <summary><b>How this works (quick)</b></summary>
      <div style="margin-top:.5rem;opacity:.9">
        <p><b>Logging:</b> write sets as <code>weight x reps</code> (e.g., <code>60x10 / 60x9</code>).</p>
        <p><b>Performance chip:</b> Highly Progressive / Progressive / Maintaining / Temporary Setback ‚Äî based on volume/weight/reps vs. your previous comparable session (same gym).</p>
        <p><b>Progression:</b> add a rep or small load with full ROM & control; if form slips, hold or reduce.</p>
        <p><b>Export:</b> copy the plan, copy JSON, or send to your Logbook Google Sheet.</p>
      </div>
    </details>
  </div>
</div>

<!-- Template for advice (injected only after generation) -->
<template id="starterAdviceTpl">
  <div class="advice-card">
    <b>Starter advice</b><br>
    For the first 4‚Äì8 weeks we recommend emphasizing <i>more isolated, machine-based</i>
    movements (e.g., chest press, row machine, pulldown, leg extension/curl, lateral raise).
    This reduces coordination demands, makes it easier to feel the target muscle, and helps you
    practice full ROM and controlled tempo. Gradually introduce more free-weight compounds as
    your control and confidence grow.
  </div>
</template>

<!-- ===== HOW IT WORKS / INFO (for training page, under the generator) ===== -->
<section id="how-it-works" class="info-wrap">
  <style>
    #how-it-works.info-wrap{
      width:100%; max-width:700px; margin:2rem auto 4rem auto;
      background:#1e1e1e; border:1px solid #333; border-radius:8px; padding:2rem;
      color:#e0e0e0; box-sizing:border-box;
    }
    #how-it-works h2{ color:#ff8c00; margin:0 0 .75rem 0; }
    #how-it-works h3{ margin:1.25rem 0 .5rem 0; color:#ffd27a; }
    #how-it-works p, #how-it-works li{ line-height:1.55; }
    #how-it-works .grid{ display:grid; grid-template-columns:1fr; gap:1rem; }
    #how-it-works .card{
      background:#222; border:1px solid #2d2d2d; border-radius:8px; padding:1rem;
    }
    #how-it-works .legend{ display:grid; grid-template-columns:1fr 1fr; gap:.75rem; }
    #how-it-works .chip{
      display:flex; align-items:center; gap:.5rem; padding:.5rem .65rem;
      border-radius:6px; font-weight:600; color:#121212;
    }
    .chip.high{ background:#0B8043; color:#fff; }
    .chip.mid{  background:#34A853; color:#fff; }
    .chip.hold{ background:#FBC02D; color:#202124; }
    .chip.drop{ background:#EA4335; color:#fff; }
    #how-it-works .note{
      background:#2a210a; border:1px solid #5a3; border-radius:8px; padding:12px; color:#ffd27a;
    }
    @media (min-width: 820px){
      #how-it-works .grid{ grid-template-columns:1fr 1fr; }
    }
    #how-it-works .shots{ display:grid; gap:.75rem; }
    #how-it-works .shots img{
      width:100%; height:auto; border-radius:6px; background:#111; border:1px solid #2a2a2a;
    }
    #how-it-works .cta-row { margin-top:1rem; display:flex; gap:.6rem; flex-wrap:wrap;}
    #how-it-works .btn{
      background:#ff8c00; color:#121212; font-weight:700; padding:.75rem 1rem;
      border-radius:6px; text-decoration:none; display:inline-block;
    }
    #how-it-works .btn.ghost{
      background:transparent; color:#ff8c00; border:1px solid #ff8c00;
    }
  </style>

  <h2>How the Self-Coaching Plan works</h2>
  <p>
    Pick a goal and training frequency, choose <strong>Gym</strong> or <strong>Home</strong>, then generate your plan.
    You can reorder exercises and swap built-in alternatives. When you export, your Google Sheet tracks sessions and
    shows a <em>performance chip</em> so you instantly know if you‚Äôre trending up.
  </p>

  <div class="grid">
    <div class="card">
      <h3>What happens when you click <em>Generate</em></h3>
      <ol>
        <li>We load a curated library for your goal (Gym/Home) and chosen frequency.</li>
        <li>We assemble days with <b>sensible exercise order</b>, plus <b>alternatives</b> for each.</li>
        <li>If ‚ÄúPrefer machines‚Äù is on, the first 4‚Äì8 weeks bias to isolation/machines for safer skill-building.</li>
        <li>We enforce variety (no duplicate names in a day) and enable drag-and-drop editing.</li>
      </ol>
      <div class="note" style="margin-top:.75rem;">
        <strong>Starter advice (appears after generation):</strong><br>
        Favor machine-based/isolation work for 4‚Äì8 weeks to learn control & ROM, then re-introduce more free-weight compounds.
      </div>
    </div>

    <div class="card">
      <h3>How the performance chip works</h3>
      <ul>
        <li>Each session gets graded vs your <b>last comparable session in the same gym</b>.</li>
        <li>We look at <b>total volume</b>, <b>top set weight</b>, and <b>max reps</b> across your sets.</li>
        <li>Result is mapped to one of four chips (DV-safe text):</li>
      </ul>
      <div class="legend">
        <div class="chip high">üü¢ Highly Progressive</div>
        <div class="chip mid">üü¢ Progressive</div>
        <div class="chip hold">üü° Maintaining</div>
        <div class="chip drop">üî¥ Temporary Setback</div>
      </div>
      <p style="margin-top:.75rem;">
        Your sheet stores the exact label (no ‚ÄúInvalid‚Äù flicker) and a note with the comparison detail.
      </p>
    </div>
  </div>

  <div class="card" style="margin-top:1rem;">
    <h3>Export & your Google Sheet</h3>
    <ul>
      <li><strong>Training Plan</strong> ‚Äî your days & exercises (with alternatives).</li>
      <li><strong>Daily Log</strong> ‚Äî date, gym (or <em>Home</em>), notes, performance chip.</li>
      <li><strong>Weekly Feedback</strong> ‚Äî quick roll-ups and trends.</li>
    </ul>
    <p style="margin:.5rem 0 0 0;">
      Multiple gyms? Add them in the generator ‚Äî we compare progress <b>only within the same gym</b> so equipment differences don‚Äôt skew results.  
      In <b>Home</b> mode the gym fields are hidden and sessions are logged under <b>‚ÄúHome‚Äù</b>.
    </p>
  </div>

  <div class="card" style="margin-top:1rem;">
    <h3>Mini-FAQ</h3>
    <p><b>Do I need a trainer?</b> Not required. This is a low-cost way to learn consistency and self-coaching.
       If you later work with a coach, your clean data & logs make collaboration faster and cheaper.</p>
    <p style="margin:.25rem 0 0 0;"><b>How do I log sets?</b> Type like <code>60x10 / 60x9 / 55x11</code> directly into the plan cells.</p>
    <p style="margin:.25rem 0 0 0;"><b>Can I change exercises?</b> Yes ‚Äî drag to reorder, click the ‚Üª icon to rotate alternatives.</p>
  </div>

<div class="shots" style="margin-top:1rem;">
  <!-- Plan builder / drag & drop -->
  <img src="Assets/screen-plan-drag.png"
       alt="Generated plan with drag-and-drop and alternatives"
       loading="lazy" />

  <!-- Daily Log with performance chip -->
  <img src="Assets/screen-daily-log.png"
       alt="Daily Log entry with performance chip result"
       loading="lazy" />

  <!-- Weekly feedback roll-up -->
  <img src="Assets/screen-weekly-feedback.png"
       alt="Weekly Feedback summary generated in the sheet"
       loading="lazy" />

  <!-- Daily reports (export/success context) -->
  <img src="Assets/screen-daily-reports.png"
       alt="Auto-generated Daily Feedback reports in the sheet"
       loading="lazy" />
</div>


  <div class="cta-row">
    <a class="btn" href="#trackerForm">Generate my plan</a>
    <a class="btn ghost" href="#trainingPlanContent">See my current output</a>
  </div>
</section>
<!-- ===== /HOW IT WORKS ===== -->

<!-- conditioningLocal.js only needs to set window.conditioningFrequencies = { bodyweight, gym } -->
<script src="./conditioningLocal.js"></script>

<!-- Main module -->
<script type="module">
import { generateTrainingPlan } from './planLogic.js';

function init() {
  try {
    const lastPlan = localStorage.getItem('lastPlan');
    const lastForm = localStorage.getItem('lastFormData');
    if (lastPlan && lastForm) {
      window.currentPlanJSON = lastPlan;
      window.formData = JSON.parse(lastForm);
      const textarea = document.getElementById('trainingPlanContent');
      if (textarea) {
        textarea.value = 'Last plan loaded from cache. Click "Generate" to rebuild view.';
        document.getElementById('outputBox').style.display = 'block';
        mountAdviceOnce();
      }
    }
  } catch {}

  const apiUrl = 'https://webbyfe-proxy.quiet-king-42b1.workers.dev/';
  const goal = document.getElementById('goal');
  const frequency = document.getElementById('frequency');
  const email = document.getElementById('email');
  const gymFields = document.getElementById('gymFields');
  const addGymButton = document.getElementById('addGymButton');
  const gymsBlock = document.getElementById('gymsBlock');
  const preferMachinesEl = document.getElementById('preferMachines');
  const locRadios = Array.from(document.querySelectorAll('input[name="loc"]'));

  function addGymField(value = '') {
    const wrapper = document.createElement('div');
    wrapper.className = 'gym-input-wrapper';
    const input = Object.assign(document.createElement('input'), {
      type:'text', className:'gymName', placeholder:'Your gym...', value
    });
    const removeBtn = Object.assign(document.createElement('button'), {
      type:'button', className:'remove-btn', textContent:'‚úñ'
    });
    removeBtn.onclick = () => wrapper.remove();
    wrapper.append(input, removeBtn);
    gymFields.appendChild(wrapper);
  }
  addGymField();

  function applyLocationUI(){
    const loc = (document.querySelector('input[name="loc"]:checked') || {}).value || 'gym';
    if (loc === 'home') {
      gymsBlock.style.display = 'none';
    } else {
      gymsBlock.style.display = '';
      if (!gymFields.querySelector('.gymName')) addGymField();
    }
  }
  locRadios.forEach(r => r.addEventListener('change', applyLocationUI));
  applyLocationUI();

  addGymButton?.addEventListener('click', () => addGymField());

  (function ensureCopyButtons() {
    const exportBtn = document.getElementById('continueButton');
    if (!exportBtn) return;

    if (!document.getElementById('copyBtn')) {
      exportBtn.insertAdjacentHTML('beforebegin', '<button id="copyBtn" type="button">Copy to clipboard</button>');
      const copyBtn = document.getElementById('copyBtn');
      copyBtn.addEventListener('click', async () => {
        const ta = document.getElementById('trainingPlanContent');
        const txt = (ta && ta.value || '').trim();
        if (!txt) { alert('Nothing to copy ‚Äî generate a plan first.'); return; }
        try {
          await navigator.clipboard.writeText(txt);
          copyBtn.textContent = 'Copied ‚úì';
          setTimeout(() => (copyBtn.textContent = 'Copy to clipboard'), 1500);
        } catch (e) {
          console.error(e);
          alert('Copy failed: ' + (e?.message || e));
        }
      });
    }

    if (!document.getElementById('copyJsonBtn')) {
      exportBtn.insertAdjacentHTML('beforebegin', '<button id="copyJsonBtn" type="button">Copy JSON</button>');
      const copyJsonBtn = document.getElementById('copyJsonBtn');
      copyJsonBtn.addEventListener('click', async () => {
        const json = window.currentPlanJSON || '';
        if (!json) { alert('No JSON available ‚Äî generate a plan first.'); return; }
        try {
          await navigator.clipboard.writeText(json);
          copyJsonBtn.textContent = 'JSON copied ‚úì';
          setTimeout(() => (copyJsonBtn.textContent = 'Copy JSON'), 1500);
        } catch (e) {
          console.error(e);
          alert('Copy failed: ' + (e?.message || e));
        }
      });
    }
  })();

  function updateTrainingPlanContentInTextarea() {
    const container = document.getElementById('training-container');
    const textarea = document.getElementById('trainingPlanContent');
    if (!container || !textarea) return;

    let output = '';
    const days = container.querySelectorAll('.day');
    if (!days || days.length === 0) { textarea.value = ''; return; }

    const gymNames = window.formData?.gymNames?.join(', ') || 'None';
    output += `Gyms: ${gymNames}\n\n`;

    days.forEach((day, i) => {
      const title = day.querySelector('h3')?.innerText.trim() || `Day ${i + 1}`;
      output += `${title}\n`;
      day.querySelectorAll('.exercise').forEach(ex => {
        const tempEx = ex.cloneNode(true);
        tempEx.querySelectorAll('.alt-list, .alt-button').forEach(el => el.remove());
        const cleanedText = tempEx.textContent.replace(/\s+/g, ' ').trim();
        output += `- ${cleanedText}\n`;
      });
      output += '\n';
    });

    textarea.value = output.trim();
  }
  window.updateTrainingPlanContentInTextarea = updateTrainingPlanContentInTextarea;

  function mountAdviceOnce(){
    if (window.__adviceMounted) return;
    const tpl  = document.getElementById('starterAdviceTpl');
    const slot = document.getElementById('starterAdviceMount');
    if (tpl && slot) {
      slot.appendChild(tpl.content.cloneNode(true));
      window.__adviceMounted = true;
    }
  }

  document.getElementById('trackerForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const loc = (document.querySelector('input[name="loc"]:checked') || {}).value || 'gym';

    let gymNames = [];
    if (loc === 'home') {
      gymNames = ['Home'];
    } else {
      gymNames = Array.from(document.querySelectorAll('.gymName')).map(x => x.value.trim()).filter(Boolean);
      if (!gymNames.length) return alert('Add at least one gym.');
    }

    const data = {
      goal: goal.value,
      frequency: frequency.value,
      equipment: (loc === 'home') ? 'home' : 'gym',
      experience: 'N/A',
      fixed: 'Yes',
      gymNames,
      email: email.value.trim(),
      meta: {
        trainingLocation: loc,
        gymName: (loc === 'home') ? 'Home' : (gymNames[0] || 'My Gym'),
        preferMachinesFirstBlock: !!preferMachinesEl.checked
      }
    };

    try {
      document.getElementById('outputBox').style.display = 'none';
      window.formData = data;

      await generateTrainingPlan(data);

      mountAdviceOnce();

      setTimeout(() => {
        updateTrainingPlanContentInTextarea();
        const out = document.getElementById('outputBox');
        out.style.display = 'block';
        out.scrollIntoView({ behavior: 'smooth', block: 'start' });
        document.getElementById('trainingPlanContent').setAttribute('readonly', true);
      }, 50);
    } catch (err) {
      alert('‚ùå Error generating plan: ' + (err?.message || err));
      console.error(err);
    }
  });

  document.getElementById('continueButton').addEventListener('click', async () => {
    const finalStatus = document.getElementById('finalStatus');
    finalStatus.textContent = '';
    finalStatus.style.color = '#ffa500';

    updateTrainingPlanContentInTextarea();

    const trainingPlan = document.getElementById('trainingPlanContent').value.trim();
    if (!trainingPlan) {
      finalStatus.textContent = '‚ùå Training plan is empty. Please generate a plan first, or ensure it contains exercises.';
      finalStatus.style.color = '#ff3333';
      return;
    }

    const loc = (document.querySelector('input[name="loc"]:checked') || {}).value || 'gym';
    let gymNames = [];
    if (loc === 'home') {
      gymNames = ['Home'];
    } else {
      gymNames = Array.from(document.querySelectorAll('.gymName')).map(x => x.value.trim()).filter(Boolean);
      if (!gymNames.length) gymNames = ['My Gym'];
    }

    const userName = email.value.trim() || "Anonymous";

    try {
      finalStatus.textContent = 'üì§ Uploading plan...';
      const res = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ userName, trainingPlan, gymNames })
      });
      const json = await res.json();
      if (json.success) {
        finalStatus.innerHTML = `‚úÖ <a href="${json.url}" target="_blank" rel="noopener noreferrer">Open Logbook</a>`;
        finalStatus.style.color = '#00ff88';
      } else {
        throw new Error(json.error || "Unexpected server error.");
      }
    } catch (err) {
      finalStatus.textContent = `‚ùå ${err.message}. Please check your Apps Script deployment and logs.`;
      finalStatus.style.color = '#ff3333';
    }
  });
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}

console.log('[conditioning] loaded', window.conditioningFrequencies && Object.keys(window.conditioningFrequencies));
</script>
</body>
</html>
