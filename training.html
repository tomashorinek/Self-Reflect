<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Self-Coaching Plan Generator</title>
<style>
:root{
  --bg:#0b0b0f;
  --bg-2:#101016;
  --panel:#15151b;
  --panel-2:#1b1b22;
  --ink:#f2f2f3;
  --ink-dim:#b9b9c3;
  --line:rgba(255,255,255,.10);
  --line-2:rgba(255,255,255,.07);
  --brand:#ff8c00;
  --brand-2:#ffb14a;
  --good:#00ff88;
  --bad:#ff3333;

  --r-lg:16px;
  --r-md:12px;
  --shadow: 0 18px 50px rgba(0,0,0,.45);
}

*{box-sizing:border-box;}
html,body{height:100%;}

body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
  margin:0;
  padding:32px 18px 60px;
  color:var(--ink);
  background: radial-gradient(1200px 600px at 20% -10%, rgba(255,140,0,.22), transparent 60%),
              radial-gradient(900px 500px at 90% 10%, rgba(153,69,255,.18), transparent 55%),
              radial-gradient(700px 400px at 40% 95%, rgba(0,255,136,.10), transparent 55%),
              linear-gradient(180deg, var(--bg) 0%, var(--bg-2) 100%);
  display:flex;
  flex-direction:column;
  align-items:center;
}

/* subtle grain overlay */
body::before{
  content:"";
  position:fixed;
  inset:0;
  pointer-events:none;
  opacity:.08;
  background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.9' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='140' height='140' filter='url(%23n)' opacity='.55'/%3E%3C/svg%3E");
  mix-blend-mode:overlay;
}

.container{width:100%; max-width:720px;}

/* HERO */
.hero{
  margin: 8px 0 18px;
  padding: 18px 18px 10px;
}
.badge{
  display:inline-flex;
  align-items:center;
  gap:8px;
  padding:6px 10px;
  border:1px solid var(--line);
  border-radius:999px;
  background:rgba(255,255,255,.03);
  color:var(--ink-dim);
  font-weight:700;
  letter-spacing:.2px;
  font-size:12px;
}
.hero h1{
  margin: 14px 0 6px;
  font-size: 34px;
  line-height: 1.08;
  letter-spacing:-.6px;
  color: var(--ink);
}
.hero p{
  margin: 0 0 12px;
  color: var(--ink-dim);
  max-width: 56ch;
}
.chips{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
}
.chip{
  display:inline-flex;
  align-items:center;
  padding:6px 10px;
  border-radius:999px;
  background:rgba(255,140,0,.12);
  border:1px solid rgba(255,140,0,.22);
  color: var(--brand-2);
  font-weight:700;
  font-size:12px;
}

/* PANELS */
form,.output,#how-it-works.info-wrap{
  background: rgba(21,21,27,.92);
  backdrop-filter: blur(10px);
  border: 1px solid var(--line);
  border-radius: var(--r-lg);
  box-shadow: var(--shadow);
  width:100%;
}

form,.output{ padding: 22px; }
@media (min-width:700px){
  form,.output{ padding: 26px; }
}

h2{ margin: .25rem 0 1rem 0; color: var(--ink); }
label{
  display:block;
  margin-top: 14px;
  margin-bottom: 8px;
  font-weight: 800;
  color: var(--ink);
  letter-spacing:.1px;
  font-size: 13px;
  text-transform: none;
}

select,input,textarea{
  width:100%;
  padding: 12px 12px;
  border-radius: 12px;
  background: rgba(255,255,255,.04);
  color: var(--ink);
  border: 1px solid var(--line-2);
  outline: none;
  transition: border-color .15s ease, background .15s ease, transform .15s ease;
}
  /* ===== DARK SELECT FIX (Windows) ===== */
select{
  color-scheme: dark;           /* d≈Øle≈æit√© */
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  background-image:
    linear-gradient(45deg, transparent 50%, var(--ink-dim) 50%),
    linear-gradient(135deg, var(--ink-dim) 50%, transparent 50%);
  background-position:
    calc(100% - 18px) calc(50% - 3px),
    calc(100% - 12px) calc(50% - 3px);
  background-size: 6px 6px, 6px 6px;
  background-repeat: no-repeat;
  padding-right: 38px;
}

/* rozbalen√© polo≈æky (ne v≈°ude 100%, ale ƒçasto pom≈Ø≈æe) */
select option{
  background: #15151b;
  color: var(--ink);
}
select:focus,input:focus,textarea:focus{
  border-color: rgba(255,140,0,.45);
  background: rgba(255,255,255,.06);
}

.inline{ display:flex; gap:14px; align-items:center; }
.inline label{ margin:0; font-weight:700; color:var(--ink-dim); }

/* SEGMENTED (Location) */
.segmented{
  display:flex;
  gap:10px;
  margin-top: 6px;
}
.segmented input{ display:none; }
.seg-card{
  flex:1;
  display:flex;
  gap:10px;
  align-items:center;
  justify-content:center;
  padding: 12px 10px;
  border-radius: 14px;
  border:1px solid var(--line-2);
  background: rgba(255,255,255,.03);
  cursor:pointer;
  user-select:none;
  transition: transform .12s ease, border-color .12s ease, background .12s ease;
}
.seg-ico{ font-size:16px; }
.seg-txt{ font-weight:900; color: var(--ink); letter-spacing:.2px; }
#locGym:checked + label,
#locHome:checked + label{
  border-color: rgba(255,140,0,.45);
  background: rgba(255,140,0,.12);
  transform: translateY(-1px);
}

/* SWITCH */
.switch-row{
  display:flex;
  align-items:center;
  gap:12px;
  padding: 12px 12px;
  border-radius: 14px;
  border:1px solid var(--line-2);
  background: rgba(255,255,255,.02);
  cursor:pointer;
  user-select:none;
}
.switch-row input{ display:none; }
.switch-ui{
  width:44px; height:26px;
  border-radius:999px;
  border:1px solid var(--line-2);
  background: rgba(255,255,255,.06);
  position:relative;
  flex: 0 0 auto;
}
.switch-ui::after{
  content:"";
  width:20px; height:20px;
  border-radius:999px;
  background: rgba(255,255,255,.75);
  position:absolute;
  top:2px; left:2px;
  transition: transform .14s ease, background .14s ease;
}
#preferMachines:checked + .switch-ui{
  border-color: rgba(255,140,0,.45);
  background: rgba(255,140,0,.18);
}
#preferMachines:checked + .switch-ui::after{
  transform: translateX(18px);
  background: rgba(255,210,122,.95);
}
.switch-text{ color: var(--ink); font-weight:800; }

/* GYMS */
#gymsBlock{ margin-top: 14px; }
.gym-input-wrapper{
  display:flex;
  gap:10px;
  margin-top:8px;
}
.remove-btn{
  width:44px;
  min-width:44px;
  padding:0;
  border:none;
  border-radius:12px;
  cursor:pointer;
  color:#fff;
  background: rgba(255,255,255,.06);
  border:1px solid var(--line-2);
  transition: transform .12s ease, background .12s ease, border-color .12s ease;
}
  /* ===== Export notice (premium loader) ===== */
.export-notice{
  border: 1px solid rgba(255,140,0,.22);
  background: rgba(255,140,0,.08);
  border-radius: 14px;
  padding: 14px;
}
.export-notice__top{
  display:flex;
  gap:12px;
  align-items:flex-start;
}
.export-dot{
  width:10px; height:10px;
  border-radius:999px;
  margin-top:6px;
  background: var(--brand);
  box-shadow: 0 0 0 6px rgba(255,140,0,.15);
  animation: pulseDot 1.4s ease-in-out infinite;
}
@keyframes pulseDot{
  0%,100%{ transform: scale(1); opacity:.9; }
  50%{ transform: scale(1.15); opacity:1; }
}
.export-notice__title{
  font-weight: 950;
}
.export-notice__sub{
  color: var(--ink-dim);
  margin-top:2px;
}
.export-notice__meta{
  margin-top:10px;
  font-size:12px;
  color: var(--ink-dim);
  font-weight:700;
}
.export-bar{
  margin-top:10px;
  height: 10px;
  border-radius: 999px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.08);
  overflow:hidden;
}
.export-bar__fill{
  height:100%;
  width: 8%;
  border-radius: 999px;
  background: linear-gradient(135deg, var(--brand) 0%, var(--brand-2) 100%);
  transition: width .6s ease;
}
.export-notice__tips{
  display:flex;
  flex-direction:column;
  gap:6px;
  margin-top:10px;
  font-size:13px;
}
.remove-btn:hover{
  background: rgba(255,51,51,.18);
  border-color: rgba(255,51,51,.35);
  transform: translateY(-1px);
}

/* BUTTONS */
button{
  border:none;
  border-radius: 14px;
  cursor:pointer;
  font-weight: 900;
  letter-spacing: .2px;
  padding: 14px 14px;
  width:100%;
  margin-top: 16px;
  font-size: 15px;
  transition: transform .12s ease, filter .12s ease, background .12s ease;
}
button:hover{ transform: translateY(-1px); filter: brightness(1.05); }

#trackerForm button[type="submit"]{
  margin-top: 18px;
  background: linear-gradient(135deg, var(--brand) 0%, var(--brand-2) 100%);
  color: #121212;
  box-shadow: 0 12px 28px rgba(255,140,0,.18);
}

/* Secondary */
.btn-secondary{
  margin-top: 10px;
  background: rgba(255,255,255,.04);
  border: 1px solid var(--line-2);
  color: var(--ink);
  font-weight: 800;
}
.btn-secondary:hover{
  background: rgba(255,255,255,.06);
}

/* output blocks */
.output{ margin-top: 18px; }
#trainingPlanContent{
  width:100%;
  height:260px;
  margin-top: 12px;
  border-radius: 14px;
  background: rgba(0,0,0,.25);
  border:1px solid var(--line-2);
  padding: 14px;
  color: var(--ink);
}

/* day/exercise cards */
.day{
  margin-bottom: 14px;
  padding: 14px;
  background: rgba(255,255,255,.03);
  border:1px solid var(--line-2);
  border-radius: 14px;
}
.exercise{
  padding: 10px 10px;
  margin-bottom: 8px;
  background: rgba(255,255,255,.04);
  border:1px solid var(--line-2);
  border-radius: 12px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:grab;
}
.alt-button{ cursor:pointer; margin-left: 10px; opacity:.9; }

/* Advice */
.advice-card{
  margin: 10px 0 16px;
  padding: 14px;
  border-radius: 14px;
  border: 1px solid rgba(255,140,0,.22);
  background: rgba(255,140,0,.10);
  color: var(--ink);
}
.advice-card b{ font-weight: 900; color: var(--brand-2); }

/* HOW IT WORKS panel (keep yours, just soften) */
#how-it-works.info-wrap{
  margin: 18px auto 0;
  padding: 18px;
  color: var(--ink);
  box-sizing:border-box;
}
#how-it-works h2{ color: var(--brand-2); margin:0 0 .75rem 0; }
#how-it-works .card{
  background: rgba(255,255,255,.03);
  border:1px solid var(--line-2);
  border-radius: 14px;
  padding: 14px;
}
#how-it-works .chip{
  border-radius: 12px;
}
  .issue-grid{
  display:grid;
  grid-template-columns: 1fr;
  gap:10px;
  margin-top: 8px;
}
@media (min-width: 620px){
  .issue-grid{ grid-template-columns: 1fr 1fr; }
}

.pill{
  display:flex;
  align-items:center;
  gap:10px;
  padding:12px 12px;
  border-radius:14px;
  border:1px solid var(--line-2);
  background: rgba(255,255,255,.03);
  cursor:pointer;
  user-select:none;
  margin:0; /* d≈Øle≈æit√© proti default label margin≈Øm */
}
.pill input{ 
  width:18px; height:18px;
  accent-color: var(--brand);
  margin:0;
}
.pill span{
  font-weight:800;
  color: var(--ink);
  line-height:1.2;
}
.pill:has(input:checked){
  border-color: rgba(255,140,0,.45);
  background: rgba(255,140,0,.12);
}
  .pill:hover{
  background: rgba(255,255,255,.05);
  transform: translateY(-1px);
}
.pill{
  transition: transform .12s ease, background .12s ease, border-color .12s ease;
}
  /* ===== Export notice (premium loader) ===== */
.export-notice{
  border: 1px solid rgba(255,140,0,.22);
  background: rgba(255,140,0,.08);
  border-radius: 14px;
  padding: 14px;
}
.export-notice__top{
  display:flex;
  gap:12px;
  align-items:flex-start;
}
.export-dot{
  width:10px; height:10px;
  border-radius:999px;
  margin-top:6px;
  background: var(--brand);
  box-shadow: 0 0 0 6px rgba(255,140,0,.15);
  animation: pulseDot 1.4s ease-in-out infinite;
}
@keyframes pulseDot{
  0%,100%{ transform: scale(1); opacity:.9; }
  50%{ transform: scale(1.15); opacity:1; }
}
.export-notice__title{
  font-weight: 950;
  letter-spacing: -.2px;
}
.export-notice__sub{
  color: var(--ink-dim);
  margin-top:2px;
  line-height: 1.25;
}
.export-notice__meta{
  margin-top:10px;
  color: var(--ink-dim);
  font-weight: 750;
  font-size: 12px;
}
.export-bar{
  margin-top:10px;
  height: 10px;
  border-radius: 999px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.08);
  overflow:hidden;
}
.export-bar__fill{
  height:100%;
  width: 8%;
  border-radius: 999px;
  background: linear-gradient(135deg, var(--brand) 0%, var(--brand-2) 100%);
  transition: width .6s ease;
}
.export-notice__tips{
  display:flex;
  flex-direction:column;
  gap:6px;
  margin-top:10px;
  color: rgba(242,242,243,.92);
  font-size: 13px;
}

</style>
<!-- Sortable.js (for DnD in planLogic.js) -->
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
</head>
<body>
<div class="container">

  <header class="hero">
    <div class="hero-top">
      <div class="badge">Self-Coach</div>
      <h1>Build your training system</h1>
      <p>Answer a few questions. We generate your plan + logbook.</p>
      <div class="chips">
        <span class="chip">Plan</span>
        <span class="chip">Logbook</span>
        <span class="chip">Feedback</span>
      </div>
    </div>
  </header>


  <form id="trackerForm">
    <label for="goal">What's your main goal?</label>
    <select id="goal">
      <option value="Build muscle">Build muscle</option>
      <option value="Lose fat">Lose fat</option>
      <option value="Get stronger">Get stronger</option>
      <option value="Improve conditioning">Improve conditioning</option>
    </select>

    <label for="frequency">Training days per week:</label>
    <select id="frequency">
      <option value="1-2">1‚Äì2</option>
      <option value="3-4">3‚Äì4</option>
      <option value="5">5</option>
      <option value="5+">5+</option>
    </select>

<label>Location</label>
<div class="segmented">
  <input type="radio" id="locGym" name="loc" value="gym" checked>
  <label for="locGym" class="seg-card">
    <span class="seg-ico">üèãÔ∏è</span>
    <span class="seg-txt">Gym</span>
  </label>

  <input type="radio" id="locHome" name="loc" value="home">
  <label for="locHome" class="seg-card">
    <span class="seg-ico">üè†</span>
    <span class="seg-txt">Home</span>
  </label>
</div>

<div class="row">
  <div class="advice-card" style="margin-top:12px;">
    <b>Beginner tip</b><br>
    Start with machines for 4‚Äì8 weeks to learn control & full ROM.
  </div>
</div>


    <div id="gymsBlock">
      <label>Your Gyms:</label>
      <div id="gymFields"></div>
      <button type="button" id="addGymButton" class="btn-secondary">‚ûï Add another gym</button>
    </div>

    <label for="email">Your email (optional):</label>
    <input type="email" id="email" placeholder="you@example.com" />
<!-- ===== Supplements (optional) ===== -->
<label for="weightKg">Body weight (kg) (optional):</label>
<input type="number" id="weightKg" min="30" max="250" step="0.1" placeholder="e.g., 82.5" />

<label>What do you want help with? (optional)</label>
<div class="issue-grid">
  <label class="pill"><input type="checkbox" class="suppIssue" value="sleep"><span>Sleep</span></label>
  <label class="pill"><input type="checkbox" class="suppIssue" value="stress"><span>Stress</span></label>
  <label class="pill"><input type="checkbox" class="suppIssue" value="cramps"><span>Cramps</span></label>
  <label class="pill"><input type="checkbox" class="suppIssue" value="lowBP"><span>Low blood pressure</span></label>
  <label class="pill"><input type="checkbox" class="suppIssue" value="highBP"><span>High blood pressure</span></label>
  <label class="pill"><input type="checkbox" class="suppIssue" value="digestion"><span>Digestion issues</span></label>
</div>


<label for="dietType">Diet type (optional)</label>
<select id="dietType">
  <option value="">Prefer not to say</option>
  <option value="omnivore">Omnivore</option>
  <option value="vegetarian">Vegetarian</option>
  <option value="vegan">Vegan</option>
</select>

<label for="budgetTier">Budget (optional)</label>
<select id="budgetTier">
  <option value="">Doesn't matter</option>
  <option value="low">Low</option>
  <option value="mid">Medium</option>
  <option value="high">High</option>
</select>
<!-- ===== /Supplements ===== -->

    <button type="submit">Generate My Plan</button>
  </form>

  <div class="output" id="outputBox" style="display:none">
  <div id="starterAdviceMount"></div>  <!-- advice appears here after generation -->
  <h2>Your Training Plan</h2>

  <div id="training-container"></div>
  <textarea id="trainingPlanContent" readonly></textarea>

  <button id="continueButton" type="button">Export Plan</button>
  <div id="finalStatus"></div>

  <div id="exportNotice" style="display:none; margin-top:10px;">
    <div class="export-notice">
      <div class="export-notice__top">
        <span class="export-dot"></span>
        <div>
          <div class="export-notice__title">Creating your Logbook‚Ä¶</div>
          <div class="export-notice__sub">
            This step can take <b>30‚Äì70 seconds</b>. Please keep this tab open.
          </div>
        </div>
      </div>

      <div class="export-notice__meta" id="exportMeta">0s ‚Ä¢ sending request</div>

      <div class="export-bar">
        <div class="export-bar__fill" id="exportBarFill"></div>
      </div>

      <div class="export-notice__tips">
        <span>‚úÖ Your plan is being generated in Google Sheets</span>
        <span>‚õî Don‚Äôt refresh or close the page</span>
      </div>
    </div>
  </div>

  <!-- Brief explainer -->
  <details style="margin-top:1rem">
    <summary><b>How this works (quick)</b></summary>
    <div style="margin-top:.5rem;opacity:.9">
      <p><b>Logging:</b> write sets as <code>weight x reps</code> (e.g., <code>60x10 / 60x9</code>).</p>
      <p><b>Performance chip:</b> Highly Progressive / Progressive / Maintaining / Temporary Setback ‚Äî based on volume/weight/reps vs. your previous comparable session (same gym).</p>
      <p><b>Progression:</b> add a rep or small load with full ROM & control; if form slips, hold or reduce.</p>
      <p><b>Export:</b> copy the plan, copy JSON, or send to your Logbook Google Sheet.</p>
    </div>
  </details>
</div>

<!-- Template for advice (injected only after generation) -->
<template id="starterAdviceTpl">
  <div class="advice-card">
    <b>Starter advice</b><br>
    For the first 4‚Äì8 weeks we recommend emphasizing <i>more isolated, machine-based</i>
    movements (e.g., chest press, row machine, pulldown, leg extension/curl, lateral raise).
    This reduces coordination demands, makes it easier to feel the target muscle, and helps you
    practice full ROM and controlled tempo. Gradually introduce more free-weight compounds as
    your control and confidence grow.
  </div>
</template>

<!-- ===== HOW IT WORKS / INFO (under the generator) ===== -->
<section id="how-it-works" class="info-wrap">
  <h2>How the Self-Coaching Plan works</h2>
  <p>
    Pick a goal and training frequency, choose <strong>Gym</strong> or <strong>Home</strong>, then generate your plan.
    You can reorder exercises and rotate <em>Alternatives</em> on the web. When you export, your Google Sheet tracks sessions and
    shows a <em>performance chip</em> so you instantly know if you‚Äôre trending up.
  </p>

  <div class="grid">
    <div class="card">
      <h3>What happens when you click <em>Generate</em></h3>
      <ol>
        <li>We load a curated exercise library that matches your goal (Gym/Home) and weekly frequency.</li>
        <li>We assemble days with a sensible exercise order and attach <b>Alternatives</b> to every item.</li>
        <li>If ‚ÄúPrefer machines‚Äù is on, the first 4‚Äì8 weeks bias to isolation/machines for safer skill-building.</li>
        <li><b>Editing & swaps happen on the web</b> (Generated Training). The Google Sheet is for logging and reports.</li>
      </ol>
      <div class="note" style="margin-top:.75rem;">
        <strong>Starter advice (appears after generation):</strong><br>
        Favor machine-based/isolation work for 4‚Äì8 weeks to learn control & ROM, then re-introduce more free-weight compounds.
      </div>
    </div>

    <div class="card">
      <h3>How the performance chip works</h3>
      <ul>
        <li>Each session gets graded vs your <b>last comparable session in the same gym</b>.</li>
        <li>We look at <b>total volume</b>, <b>top set weight</b>, and <b>max reps</b> across your sets.</li>
        <li>Result is mapped to one of four chips (DV-safe text):</li>
      </ul>
      <div class="legend">
        <div class="chip high">üü¢ Highly Progressive</div>
        <div class="chip mid">üü¢ Progressive</div>
        <div class="chip hold">üü° Maintaining</div>
        <div class="chip drop">üî¥ Temporary Setback</div>
      </div>
      <p style="margin-top:.75rem;">
        Your sheet stores the exact label (no ‚ÄúInvalid‚Äù flicker) and a note with the comparison detail.
      </p>
    </div>
  </div>

  <!-- Extra explainer for auto-fill -->
  <div class="card" style="margin-top:1rem;">
    <h3>Auto-fill & logging basics</h3>
    <p>
      When a session is synced from the web ‚Äî or when you paste performed sets (e.g., <code>60x10 / 60x9</code>) ‚Äî the log row can
      <b>auto-stamp the Date and compute Performance</b> vs your last comparable session in the same gym.
      If the exercise differs from the last comparable one (e.g., you switched to an Alternative), that day is scored as
      <b>Maintaining (score 0)</b> to avoid false negatives. Next time with the same exercise, it will compare normally.
    </p>
  </div>

  <!-- ===== Screenshots with captions ===== -->
  <div class="shots" style="margin-top:1rem;">
    <!-- Plan/logbook view -->
    <figure>
      <a href="Assets/screen-plan-drag.png.png" target="_blank" rel="noopener">
        <img src="Assets/screen-plan-drag.png.png"
             alt="Logbook view with generated plan rows and weekly window"
             loading="lazy" decoding="async">
      </a>
      <figcaption><b>Logbook view.</b> Your generated plan as rows in the Sheet. Editing and alternatives are done on the web; the log keeps your performed sets and performance results.</figcaption>
    </figure>

    <!-- Daily Log with performance chip -->
    <figure>
      <a href="Assets/screen-daily-log.png.png" target="_blank" rel="noopener">
        <img src="Assets/screen-daily-log.png.png"
             alt="Daily Log sheet with date, weight, sleep, adherence, performance chip, calories, mood, stress"
             loading="lazy" decoding="async">
      </a>
      <figcaption><b>Daily Log.</b> One row per day with dropdowns (Sleep, Food Adherence, Performance, Mood, Stress) plus Calories and Weight for weekly roll-ups.</figcaption>
    </figure>

    <!-- Weekly feedback roll-up -->
    <figure>
      <a href="Assets/screen-weekly-feedback.png.png" target="_blank" rel="noopener">
        <img src="Assets/screen-weekly-feedback.png.png"
             alt="Weekly Feedback summary with averages and Performance Index"
             loading="lazy" decoding="async">
      </a>
      <figcaption><b>Weekly Feedback.</b> Averages, total calories, a Performance Index and short, phase-aware recommendations for weight & intake.</figcaption>
    </figure>

    <!-- Daily reports (export/success context) -->
    <figure>
      <a href="Assets/screen-daily-reports.png.png" target="_blank" rel="noopener">
        <img src="Assets/screen-daily-reports.png.png"
             alt="Auto-generated Daily Feedback reports in the sheet"
             loading="lazy" decoding="async">
      </a>
      <figcaption><b>Daily Feedback Reports.</b> The newest daily summary always lands on top (A2). Clear ‚ÄúFocus today‚Äù items help you act the same day.</figcaption>
    </figure>

    <!-- Optional: Config -->
    <figure>
      <a href="Assets/Config.png" target="_blank" rel="noopener">
        <img src="Assets/Config.png"
             alt="Config sheet ‚Äî control center with phase, time rules and toggles"
             loading="lazy" decoding="async">
      </a>
      <figcaption><b>Config.</b> Control center: phase, time rules, manual toggles and the auto-weekly switch.</figcaption>
    </figure>

    <!-- Optional: Web training -->
    <figure>
      <a href="Assets/WebTraining.png" target="_blank" rel="noopener">
        <img src="Assets/WebTraining.png"
             alt="Web Generated Training list with alternatives and swap icons"
             loading="lazy" decoding="async">
      </a>
      <figcaption><b>Web ‚Äî Generated Training.</b> Edit order, rotate Alternatives and then export to the logbook.</figcaption>
    </figure>
  </div>

  <div class="cta-row">
    <a class="btn" href="#trackerForm">Generate my plan</a>
    <a class="btn ghost" href="#trainingPlanContent">See my current output</a>
  </div>
</section>
<!-- ===== /HOW IT WORKS ===== -->

<!-- conditioningLocal.js only needs to set window.conditioningFrequencies = { bodyweight, gym } -->
<script src="./conditioningLocal.js"></script>

<!-- Main module -->
<script type="module">
import { generateTrainingPlan } from './planLogic.js';

function parseExercise(el) {
  // kompletn√≠ text z dla≈ædice (1. ≈ô√°dek = n√°zev ‚Äì rozsah, 2. ≈ô√°dek = "Alt: ...")
  const raw = el.innerText.replace(/\s+/g, ' ').trim();

  // rozdƒõl√≠me na "main" a "alt ƒç√°st"
  const parts = raw.split(/Alt:\s*/i);
  const main = (parts[0] || '').trim();
  const altStr = (parts[1] || '').trim();

  // rozdƒõlen√≠ n√°zvu a rozsahu ‚Äì en-dash (‚Äì) nebo pomlƒçka (-)
let name = main;
let range = '';

// split only on separators that are very likely "name ‚Äî range"
const sepCandidates = [' ‚Äì ', ' - '];
let cut = -1;
let sepLen = 0;

for (const sep of sepCandidates) {
  const idx = main.indexOf(sep);
  if (idx > -1) { cut = idx; sepLen = sep.length; break; }
}

if (cut > -1) {
  name = main.slice(0, cut).trim();
  range = main.slice(cut + sepLen).trim();
}

  const alternatives = altStr
    ? altStr.split(',').map(s => s.trim()).filter(Boolean)
    : [];

  return { raw, main, name, range, alternatives };
}

/* Poskl√°d√° strukturovan√Ω JSON cel√©ho pl√°nu ‚Äì pro Apps Script */
function collectPlanJSON() {
  const container = document.getElementById('training-container');
  const loc = (document.querySelector('input[name="loc"]:checked') || {}).value || 'gym';
  const gymNames =
    loc === 'home'
      ? ['Home']
      : Array.from(document.querySelectorAll('.gymName')).map(x => x.value.trim()).filter(Boolean);

  const days = [];
  container?.querySelectorAll('.day')?.forEach(dayEl => {
    const title = dayEl.querySelector('h3')?.innerText.trim() || 'Day';
    const exercises = [];
    dayEl.querySelectorAll('.exercise')?.forEach(exEl => {
      const parsed = parseExercise(exEl);
      exercises.push({
        name: parsed.name,
        range: parsed.range,
        alternatives: parsed.alternatives
      });
    });
    days.push({ title, exercises });
  });

  return {
    version: 2,
    meta: { location: loc, gymNames },
    days
  };
}
window.collectPlanJSON = collectPlanJSON;

function updateTrainingPlanContentInTextarea() {
  const container = document.getElementById('training-container');
  const textarea = document.getElementById('trainingPlanContent');
  if (!container || !textarea) return;

  const days = container.querySelectorAll('.day');
  if (!days || days.length === 0) { textarea.value = ''; return; }

  const out = [];
// IMPORTANT: keep text format stable for legacy parsers in Apps Script
// (do not add headers like "Gyms:", because it shifts row mapping)

  days.forEach((day, i) => {
    const title = day.querySelector('h3')?.innerText.trim() || `Day ${i + 1}`;
    out.push(title);

    day.querySelectorAll('.exercise').forEach(exEl => {
      const ex = parseExercise(exEl);
      // hlavn√≠ ≈ô√°dek
      out.push(`- ${ex.main}`);
      // pokud m√°me alternativy, vyp√≠≈°eme je na dal≈°√≠ ≈ô√°dek
      if (ex.alternatives.length) {
        out.push(`  Alt: ${ex.alternatives.join(', ')}`);
      }
    });

    out.push(''); // pr√°zdn√Ω ≈ô√°dek mezi dny
  });

  textarea.value = out.join('\n').trim();
}

function mountAdviceOnce(){
  if (window.__adviceMounted) return;
  const tpl  = document.getElementById('starterAdviceTpl');
  const slot = document.getElementById('starterAdviceMount');
  if (tpl && slot) {
    slot.appendChild(tpl.content.cloneNode(true));
    window.__adviceMounted = true;
  }
}

function init() {
  try {
    const lastPlan = localStorage.getItem('lastPlan');
    const lastForm = localStorage.getItem('lastFormData');
    if (lastPlan && lastForm) {
      window.currentPlanJSON = lastPlan;
      window.formData = JSON.parse(lastForm);
      const textarea = document.getElementById('trainingPlanContent');
      if (textarea) {
        textarea.value = 'Last plan loaded from cache. Click "Generate" to rebuild view.';
        document.getElementById('outputBox').style.display = 'block';
        mountAdviceOnce();
      }
    }
  } catch {}

  const apiUrl = 'https://webbyfe-proxy.quiet-king-42b1.workers.dev/';
  const goal = document.getElementById('goal');
  const frequency = document.getElementById('frequency');
  const email = document.getElementById('email');
  const gymFields = document.getElementById('gymFields');
  const addGymButton = document.getElementById('addGymButton');
  const gymsBlock = document.getElementById('gymsBlock');
  const preferMachinesEl = document.getElementById('preferMachines'); // m≈Ø≈æe b√Ωt null (tip-only UI)
  // Supplements (optional)
  const weightKgEl = document.getElementById('weightKg');
  const dietTypeEl = document.getElementById('dietType');
  const budgetTierEl = document.getElementById('budgetTier');
  console.log('[supp elements]', {
  weightKgEl: !!weightKgEl,
  dietTypeEl: !!dietTypeEl,
  budgetTierEl: !!budgetTierEl,
  issuesFound: document.querySelectorAll('.suppIssue').length
});

  const locRadios = Array.from(document.querySelectorAll('input[name="loc"]'));

  function addGymField(value = '') {
    const wrapper = document.createElement('div');
    wrapper.className = 'gym-input-wrapper';
    const input = Object.assign(document.createElement('input'), {
      type:'text', className:'gymName', placeholder:'Your gym...', value
    });
    const removeBtn = Object.assign(document.createElement('button'), {
      type:'button', className:'remove-btn', textContent:'‚úñ'
    });
    removeBtn.onclick = () => wrapper.remove();
    wrapper.append(input, removeBtn);
    gymFields.appendChild(wrapper);
  }
  addGymField();

  function applyLocationUI(){
    const loc = (document.querySelector('input[name="loc"]:checked') || {}).value || 'gym';
    if (loc === 'home') {
      gymsBlock.style.display = 'none';
    } else {
      gymsBlock.style.display = '';
      if (!gymFields.querySelector('.gymName')) addGymField();
    }
  }
  locRadios.forEach(r => r.addEventListener('change', applyLocationUI));
  applyLocationUI();

  addGymButton?.addEventListener('click', () => addGymField());

  (function ensureCopyButtons() {
    const exportBtn = document.getElementById('continueButton');
    if (!exportBtn) return;

    if (!document.getElementById('copyBtn')) {
      exportBtn.insertAdjacentHTML('beforebegin', '<button id="copyBtn" type="button">Copy to clipboard</button>');
      const copyBtn = document.getElementById('copyBtn');
      copyBtn.addEventListener('click', async () => {
        const ta = document.getElementById('trainingPlanContent');
        const txt = (ta && ta.value || '').trim();
        if (!txt) { alert('Nothing to copy ‚Äî generate a plan first.'); return; }
        try {
          await navigator.clipboard.writeText(txt);
          copyBtn.textContent = 'Copied ‚úì';
          setTimeout(() => (copyBtn.textContent = 'Copy to clipboard'), 1500);
        } catch (e) {
          console.error(e);
          alert('Copy failed: ' + (e?.message || e));
        }
      });
    }

    if (!document.getElementById('copyJsonBtn')) {
      exportBtn.insertAdjacentHTML('beforebegin', '<button id="copyJsonBtn" type="button">Copy JSON</button>');
      const copyJsonBtn = document.getElementById('copyJsonBtn');
      copyJsonBtn.addEventListener('click', async () => {
        const obj = collectPlanJSON();
        const json = JSON.stringify(obj || {}, null, 2);
        try {
          await navigator.clipboard.writeText(json);
          copyJsonBtn.textContent = 'JSON copied ‚úì';
          setTimeout(() => (copyJsonBtn.textContent = 'Copy JSON'), 1500);
        } catch (e) {
          console.error(e);
          alert('Copy failed: ' + (e?.message || e));
        }
      });
    }
  })();

  document.getElementById('trackerForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    const loc = (document.querySelector('input[name="loc"]:checked') || {}).value || 'gym';

    let gymNames = [];
    if (loc === 'home') {
      gymNames = ['Home'];
    } else {
      gymNames = Array.from(document.querySelectorAll('.gymName')).map(x => x.value.trim()).filter(Boolean);
      if (!gymNames.length) return alert('Add at least one gym.');
    }

    const data = {
      goal: goal.value,
      frequency: frequency.value,
      equipment: (loc === 'home') ? 'home' : 'gym',
      experience: 'N/A',
      fixed: 'Yes',
      gymNames,
      email: email.value.trim(),
      meta: {
        trainingLocation: loc,
        gymName: (loc === 'home') ? 'Home' : (gymNames[0] || 'My Gym'),
        preferMachinesFirstBlock: !!(preferMachinesEl && preferMachinesEl.checked)
      }
    };

    try {
      document.getElementById('outputBox').style.display = 'none';
      window.formData = data;

      await generateTrainingPlan(data);

      mountAdviceOnce();

      setTimeout(() => {
        updateTrainingPlanContentInTextarea();
        const out = document.getElementById('outputBox');
        out.style.display = 'block';
        out.scrollIntoView({ behavior: 'smooth', block: 'start' });
        document.getElementById('trainingPlanContent').setAttribute('readonly', true);
      }, 50);
    } catch (err) {
      alert('‚ùå Error generating plan: ' + (err?.message || err));
      console.error(err);
    }
  });

  document.getElementById('continueButton').addEventListener('click', async () => {
    const finalStatus = document.getElementById('finalStatus');
    finalStatus.textContent = '';
    finalStatus.style.color = '#ffa500';

    // Loader UI refs
    const exportBtn = document.getElementById('continueButton');
    const exportNotice = document.getElementById('exportNotice');
    const exportMeta = document.getElementById('exportMeta');
    const exportBarFill = document.getElementById('exportBarFill');

    // UI: start loading state
    exportBtn.disabled = true;
    const oldBtnText = exportBtn.textContent;
    exportBtn.textContent = 'Exporting‚Ä¶';
    exportBtn.style.opacity = '0.85';

    const noticeTimer = setTimeout(() => {
      exportNotice.style.display = 'block';
    }, 600);

    const tStart = Date.now();
    const tick = () => {
      const s = Math.floor((Date.now() - tStart) / 1000);
      const pct = Math.min(95, Math.max(8, Math.floor((s / 70) * 100)));
      exportBarFill.style.width = pct + '%';

      let msg = 'sending request';
      if (s >= 8) msg = 'creating your sheet copy';
      if (s >= 20) msg = 'importing your plan';
      if (s >= 40) msg = 'applying styling & finalizing';
      if (s >= 65) msg = 'almost there‚Ä¶';

      exportMeta.textContent = `${s}s ‚Ä¢ ${msg}`;
    };

    tick();
    const intervalId = setInterval(tick, 1000);

    // v≈ædy nejd≈ô√≠v znovu poskl√°dej textov√© znƒõn√≠
    updateTrainingPlanContentInTextarea();

    const trainingPlan = document.getElementById('trainingPlanContent').value.trim();
    if (!trainingPlan) {
      clearInterval(intervalId);
      clearTimeout(noticeTimer);

      exportBtn.disabled = false;
      exportBtn.textContent = oldBtnText;
      exportBtn.style.opacity = '';
      exportNotice.style.display = 'none';

      finalStatus.textContent = '‚ùå Training plan is empty. Please generate a plan first.';
      finalStatus.style.color = '#ff3333';
      return;
    }

    const loc = (document.querySelector('input[name="loc"]:checked') || {}).value || 'gym';
    let gymNames = [];
    if (loc === 'home') {
      gymNames = ['Home'];
    } else {
      gymNames = Array.from(document.querySelectorAll('.gymName')).map(x => x.value.trim()).filter(Boolean);
      if (!gymNames.length) gymNames = ['My Gym'];
    }

    const userName = email.value.trim() || 'Anonymous';

    try {
      finalStatus.textContent = 'üì§ Uploading plan...';

      const planObj = collectPlanJSON();

      const weightKgRaw = (weightKgEl?.value || '').trim();
      const weightKg = parseFloat(weightKgRaw);
      const suppIssues = Array.from(document.querySelectorAll('.suppIssue:checked')).map(x => x.value);

      const supplementProfile = {
        mode: "minimal",
        // star≈°√≠ skripty ƒçasto nesn√°≈°√≠ null ‚Üí rad≈°i '' nebo ƒç√≠slo
        weightKg: Number.isFinite(weightKg) ? weightKg : '',
        dietType: (dietTypeEl?.value || '').trim(),
        budget: (budgetTierEl?.value || '').trim(),
        // nech√°me i array, ale p≈ôid√°me i textovou verzi
        issues: suppIssues,
        issuesText: suppIssues.join(',')
      };

const payload = {
  action: "createAndImport",
  userName,
  trainingPlan,
  gymNames,
  planJson: planObj,

  // ‚úÖ nested (nov√Ω zp≈Øsob)
  supplementProfile,
  supplements: supplementProfile,
  supplement_profile: supplementProfile,

  // ‚úÖ flat (star√© backendy / Apps Script ƒçasto ƒçek√° tohle)
  weightKg: supplementProfile.weightKg,
  dietType: supplementProfile.dietType,
  budget: supplementProfile.budget,
  issues: supplementProfile.issuesText,     // string "sleep,stress"
  issuesArr: supplementProfile.issues,      // array pro novƒõj≈°√≠ logiku

  meta: {
    version: 2,
    location: loc,
    preferMachinesFirstBlock: !!(preferMachinesEl && preferMachinesEl.checked)
  },
  flags: {
    createDropdowns: true,
    writeBaseCol: 'AA',
    baseColHeader: 'base_exercise'
  }
};

     
      console.log('[export payload]', payload);
      console.log('[supplementProfile]', payload.supplementProfile);

            console.log('[export] apiUrl =', apiUrl);

      let res;
      try {
        res = await fetch(apiUrl, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
      } catch (netErr) {
        console.error('[export] Network error (Failed to fetch):', netErr);
        throw new Error('Network error (Failed to fetch). Likely CORS, wrong URL, or Worker is down.');
      }

      const rawText = await res.text().catch(() => '');
      console.log('[export] status =', res.status);
      console.log('[export] raw response =', rawText);

      if (!res.ok) throw new Error(`HTTP ${res.status}: ${rawText || 'No response body'}`);

      let json = {};
      try {
        json = rawText ? JSON.parse(rawText) : {};
      } catch (e) {
        throw new Error('Response is not valid JSON. Raw: ' + (rawText || '(empty)'));
      }

      if (json.ok || json.success) {
        const sheetUrl = json.url || (json.data && json.data.url) || '';

        finalStatus.innerHTML = `‚úÖ <a href="${sheetUrl}" target="_blank" rel="noopener noreferrer">Open Logbook</a>`;
        finalStatus.style.color = '#00ff88';

        clearInterval(intervalId);
        clearTimeout(noticeTimer);

        exportBarFill.style.width = '100%';
        exportMeta.textContent = 'Done ‚Ä¢ opening link';
        exportNotice.style.display = 'none';

        exportBtn.disabled = false;
        exportBtn.textContent = 'Export again';
        exportBtn.style.opacity = '';

        try {
          localStorage.setItem('lastPlan', JSON.stringify(planObj));
          localStorage.setItem('lastFormData', JSON.stringify(window.formData || {}));
        } catch (_) {}
      } else {
        throw new Error(json.error || 'Unexpected server error.');
      }

    } catch (err) {
      clearInterval(intervalId);
      clearTimeout(noticeTimer);

      exportBtn.disabled = false;
      exportBtn.textContent = oldBtnText;
      exportBtn.style.opacity = '';

      exportMeta.textContent = 'Error ‚Ä¢ please try again';
      exportBarFill.style.width = '12%';
      exportNotice.style.display = 'block';

      finalStatus.textContent = `‚ùå ${err.message}. Please check your Apps Script deployment and logs.`;
      finalStatus.style.color = '#ff3333';
    }
  });

} // ‚úÖ D≈ÆLE≈ΩIT√â: t√≠mhle zav√≠r√°≈° init()

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}

console.log('[conditioning] loaded', window.conditioningFrequencies && Object.keys(window.conditioningFrequencies));
</script>
</div>
</body>
</html>
